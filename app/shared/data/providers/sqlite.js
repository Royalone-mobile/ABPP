"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var sql = require("nativescript-sqlite");
core_1.Injectable();
var Sqlite = (function () {
    function Sqlite() {
        var _this = this;
        //Queries
        this.qDbname = "abpp.db";
        this.qCreateSettingsTable = "CREATE TABLE IF NOT EXISTS settings (id INTEGER PRIMARY KEY AUTOINCREMENT, `key` VARCHAR(100), `value` TEXT)";
        this.qCreateFormsTable = "CREATE TABLE IF NOT EXISTS forms (id INTEGER PRIMARY KEY AUTOINCREMENT, form_id INTEGER, title TEXT, json TEXT, updated_at DATE DEFAULT (datetime('now','localtime')))";
        this.qCreateQueuesTable = "CREATE TABLE IF NOT EXISTS queu (id INTEGER PRIMARY KEY AUTOINCREMENT, form_id INTEGER, payload TEXT,  updated_at DATE DEFAULT (datetime('now','localtime')), status INTEGER DEFAULT 0)";
        //Getters
        this.qGetSetting = "SELECT * FROM settings WHERE `key`=?";
        this.qGetForm = "SELECT * FROM forms where form_id=?";
        this.qGetOneQueue = "SELECT * FROM queu WHERE form_id=?";
        this.qGetAllQueueStatus = "SELECT * FROM queue WHERE status=?";
        this.qGetAllForms = "SELECT * FROM forms";
        this.qGetAllSettings = "SELECT * FROM settings";
        this.qGetAllQueue = "SELECT * FROM queue";
        //Setters
        this.qSetSetting = "INSERT OR REPLACE INTO settings (id, `key`, `value`) VALUES ((SELECT id FROM settings WHERE `key`=?),?,?)";
        this.qSetForm = "INSERT OR REPLACE INTO forms (id, form_id, title, json) VALUES ((SELECT id FROM forms WHERE `form_id`=?),?,?,?)";
        this.qAddToQueue = "INSERT INTO queu (form_id, payload) VALUES (?,?)";
        this.qUpdateQueu = "UPDATE queue SET status=? WHERE form_id=?";
        this.qClearQueue = "DELETE * FROM queu";
        this.qClearForms = "DELETE * FROM forms";
        this.qClearSettings = "DELETE * FROM settings";
        this.qDeleteSetting = "DELETE FROM settings WHERE `key`=?";
        //DB Aanmaken + tabellen
        if (!this.isInstantiated) {
            //sql.deleteDatabase(this.qDbname);
            this.db = (new sql(this.qDbname));
            this.db.then(function (db) {
                db.execSQL(_this.qCreateSettingsTable).then(function (id) {
                }, function (error) {
                    console.error('Failed to create settings table!');
                });
                db.execSQL(_this.qCreateFormsTable).then(function (id) {
                }, function (error) {
                    console.error('Failed to create forms table!');
                });
                db.execSQL(_this.qCreateQueuesTable).then(function (id) {
                }, function (error) {
                    console.error('Failed to create queus table!');
                });
                //this.db = db;
                _this.isInstantiated = true;
            }, function (error) {
                console.error('Failed to open DB!');
            });
        }
    }
    Sqlite.prototype.getDbHandler = function () {
        return this.db;
    };
    Sqlite.prototype.setAuth = function (token_id) {
        return this.setSetting('auth', token_id);
    };
    Sqlite.prototype.getAuth = function () {
        return this.getSetting('auth');
    };
    Sqlite.prototype.clearAuth = function () {
        var _this = this;
        this.db.then(function (db) {
            db.execSQL(_this.qDeleteSetting, ['auth']).then(function () {
                return true;
            }, function (error) { return _this.errorHandler(error); });
        });
    };
    Sqlite.prototype.setForm = function (form) {
        var _this = this;
        this.db.then(function (db) {
            db.execSQL(_this.qSetForm, [form.Id, form.Id, form.Title, form]).then(function (value) {
                return true;
            }, function (error) { return _this.errorHandler(error); });
        });
    };
    Sqlite.prototype.getForm = function (form_id) {
        var _this = this;
        return this.db.then(function (db) {
            return db.get(_this.qGetForm, [form_id], function (err, row) {
                //row[2];
            });
        });
    };
    Sqlite.prototype.getAllForms = function () {
        var _this = this;
        return this.db.then(function (db) {
            return db.execSQL(_this.qGetAllForms, function (err, rows) { });
        });
    };
    Sqlite.prototype.clearForms = function () {
        var _this = this;
        this.db.then(function (db) {
            db.execSQL(_this.qClearForms);
        });
    };
    Sqlite.prototype.getSettings = function () {
        var _this = this;
        return this.db.then(function (db) {
            return db.all(_this.qGetAllSettings).then(function (rows) {
                //console.dump(rows);
                return rows;
            }, function (error) { return _this.errorHandler(error); });
        });
    };
    Sqlite.prototype.getSetting = function (key) {
        var _this = this;
        return this.db.then(function (db) {
            return db.get(_this.qGetSetting, [key], function (err, row) {
                if (err) {
                    this.errorHandler(err);
                }
            });
        });
    };
    Sqlite.prototype.setSetting = function (key, value) {
        var _this = this;
        return this.db.then(function (db) {
            return db.execSQL(_this.qSetSetting, [key, key, value]).then(function (value) {
            }, function (error) { return _this.errorHandler(error); });
        });
    };
    Sqlite.prototype.setSettings = function (settings) {
        var _this = this;
        return this.db.then(function (db) {
            for (var key in settings) {
                db.execSQL(_this.qSetSetting, [key, key, settings[key]])
                    .then(function (res) { }, function (error) { return _this.errorHandler(error); });
            }
        });
    };
    Sqlite.prototype.clearSettings = function () {
        var _this = this;
        this.db.then(function (db) {
            db.execSQL(_this.qClearSettings);
        });
    };
    Sqlite.prototype.addToQueue = function (form_id, payload) {
        var _this = this;
        return this.db.then(function (db) {
            return db.execSQL(_this.qAddToQueue, [form_id, payload]).then(function (id) {
                //returns ID
            }, function (error) { return _this.errorHandler(error); });
        });
    };
    Sqlite.prototype.getOneQueue = function (queu_id) {
        var _this = this;
        return this.db.then(function (db) {
            return db.get(_this.qGetOneQueue, [queu_id], function (err, row) { });
        });
    };
    Sqlite.prototype.getQueueWithStatus = function (status) {
        var _this = this;
        return this.db.then(function (db) {
            return db.execSQL(_this.qGetAllQueueStatus, [status], function (err, rows) { });
        });
    };
    Sqlite.prototype.getQueue = function () {
        var _this = this;
        return this.db.then(function (db) {
            return db.execSQL(_this.qGetAllQueue, function (err, rows) { });
        });
    };
    Sqlite.prototype.clearQueu = function () {
        var _this = this;
        this.db.then(function (db) {
            db.execSQL(_this.qClearQueue);
        });
    };
    Sqlite.prototype.clearAll = function () {
        this.clearForms();
        this.clearQueu();
        this.clearSettings();
    };
    Sqlite.prototype.errorHandler = function (error) {
        console.error("Error: " + error);
    };
    return Sqlite;
}());
exports.Sqlite = Sqlite;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3FsaXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic3FsaXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQTJDO0FBRzNDLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBRXpDLGlCQUFVLEVBQUUsQ0FBQTtBQUNaO0lBaUNJO1FBQUEsaUJBNEJDO1FBdkRELFNBQVM7UUFDRCxZQUFPLEdBQVcsU0FBUyxDQUFDO1FBQzVCLHlCQUFvQixHQUFXLDhHQUE4RyxDQUFDO1FBQzlJLHNCQUFpQixHQUFXLHdLQUF3SyxDQUFDO1FBQ3JNLHVCQUFrQixHQUFXLHlMQUF5TCxDQUFDO1FBRS9OLFNBQVM7UUFDRCxnQkFBVyxHQUFHLHNDQUFzQyxDQUFDO1FBQ3JELGFBQVEsR0FBRyxxQ0FBcUMsQ0FBQztRQUNqRCxpQkFBWSxHQUFHLG9DQUFvQyxDQUFDO1FBQ3BELHVCQUFrQixHQUFHLG9DQUFvQyxDQUFDO1FBQzFELGlCQUFZLEdBQUcscUJBQXFCLENBQUM7UUFDckMsb0JBQWUsR0FBRyx3QkFBd0IsQ0FBQztRQUMzQyxpQkFBWSxHQUFHLHFCQUFxQixDQUFDO1FBRTdDLFNBQVM7UUFDRCxnQkFBVyxHQUFHLDJHQUEyRyxDQUFDO1FBQzFILGFBQVEsR0FBRyxpSEFBaUgsQ0FBQztRQUM3SCxnQkFBVyxHQUFHLGtEQUFrRCxDQUFDO1FBQ2pFLGdCQUFXLEdBQUcsMkNBQTJDLENBQUM7UUFDMUQsZ0JBQVcsR0FBRyxvQkFBb0IsQ0FBQztRQUNuQyxnQkFBVyxHQUFHLHFCQUFxQixDQUFDO1FBQ3BDLG1CQUFjLEdBQUcsd0JBQXdCLENBQUM7UUFDMUMsbUJBQWMsR0FBRyxvQ0FBb0MsQ0FBQztRQUsxRCx3QkFBd0I7UUFDeEIsRUFBRSxDQUFBLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUEsQ0FBQztZQUNyQixtQ0FBbUM7WUFDbkMsSUFBSSxDQUFDLEVBQUUsR0FBRyxDQUFDLElBQUks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RTtZQUNsQixNQUFNLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FDYixLQUFJLENBQUMsa0JBQWtCLEVBQUMsQ0FBQyxNQUFNLENBQUMsRUFDaEMsVUFBUyxHQUFHLEVBQUMsSUFBSSxJQUFFLENBQUMsQ0FDdkIsQ0FBQztRQUNOLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELHlCQUFRLEdBQVI7UUFBQSxpQkFPQztRQU5HLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFBLEVBQUU7WUFDbEIsTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQ2IsS0FBSSxDQUFDLFlBQVksRUFDakIsVUFBUyxHQUFHLEVBQUMsSUFBSSxJQUFFLENBQUMsQ0FDdkIsQ0FBQztRQUNOLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELDBCQUFTLEdBQVQ7UUFBQSxpQkFJQztRQUhHLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQUEsRUFBRTtZQUNYLEVBQUUsQ0FBQyxPQUFPLENBQUMsS0FBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ2pDLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELHlCQUFRLEdBQVI7UUFDSSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDbEIsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN6QixDQUFDO0lBRUQsNkJBQVksR0FBWixVQUFhLEtBQUs7UUFDZCxPQUFPLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBQyxLQUFLLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBQ0wsYUFBQztBQUFELENBQUMsQUE1TUQsSUE0TUM7QUE1TVksd0JBQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IFJlcG9zaXRvcnkgfSBmcm9tIFwiLi4vcmVwb3NpdG9yeVwiO1xuaW1wb3J0IHsgQ29uZmlnIH0gZnJvbSBcIi4uLy4uL0NvbmZpZ1wiO1xudmFyIHNxbCA9IHJlcXVpcmUoXCJuYXRpdmVzY3JpcHQtc3FsaXRlXCIpO1xuXG5JbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTcWxpdGUgaW1wbGVtZW50cyBSZXBvc2l0b3J5IHtcbiAgICBcbiAgICBwcml2YXRlIGRiOiBhbnk7IC8vREIgSGFuZGxlclxuICAgIHByaXZhdGUgYXV0aFRva2VuOiBhbnk7XG4gICAgcHJpdmF0ZSBpc0luc3RhbnRpYXRlZDogYm9vbGVhbjsgLy9TaW5nbGV0b24gc3R5bGVcblxuICAgIC8vUXVlcmllc1xuICAgIHByaXZhdGUgcURibmFtZTogc3RyaW5nID0gXCJhYnBwLmRiXCI7XG4gICAgcHJpdmF0ZSBxQ3JlYXRlU2V0dGluZ3NUYWJsZTogc3RyaW5nID0gXCJDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBzZXR0aW5ncyAoaWQgSU5URUdFUiBQUklNQVJZIEtFWSBBVVRPSU5DUkVNRU5ULCBga2V5YCBWQVJDSEFSKDEwMCksIGB2YWx1ZWAgVEVYVClcIjtcbiAgICBwcml2YXRlIHFDcmVhdGVGb3Jtc1RhYmxlOiBzdHJpbmcgPSBcIkNSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIGZvcm1zIChpZCBJTlRFR0VSIFBSSU1BUlkgS0VZIEFVVE9JTkNSRU1FTlQsIGZvcm1faWQgSU5URUdFUiwgdGl0bGUgVEVYVCwganNvbiBURVhULCB1cGRhdGVkX2F0IERBVEUgREVGQVVMVCAoZGF0ZXRpbWUoJ25vdycsJ2xvY2FsdGltZScpKSlcIjtcbiAgICBwcml2YXRlIHFDcmVhdGVRdWV1ZXNUYWJsZTogc3RyaW5nID0gXCJDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBxdWV1IChpZCBJTlRFR0VSIFBSSU1BUlkgS0VZIEFVVE9JTkNSRU1FTlQsIGZvcm1faWQgSU5URUdFUiwgcGF5bG9hZCBURVhULCAgdXBkYXRlZF9hdCBEQVRFIERFRkFVTFQgKGRhdGV0aW1lKCdub3cnLCdsb2NhbHRpbWUnKSksIHN0YXR1cyBJTlRFR0VSIERFRkFVTFQgMClcIjtcblxuICAgIC8vR2V0dGVyc1xuICAgIHByaXZhdGUgcUdldFNldHRpbmcgPSBcIlNFTEVDVCAqIEZST00gc2V0dGluZ3MgV0hFUkUgYGtleWA9P1wiO1xuICAgIHByaXZhdGUgcUdldEZvcm0gPSBcIlNFTEVDVCAqIEZST00gZm9ybXMgd2hlcmUgZm9ybV9pZD0/XCI7XG4gICAgcHJpdmF0ZSBxR2V0T25lUXVldWUgPSBcIlNFTEVDVCAqIEZST00gcXVldSBXSEVSRSBmb3JtX2lkPT9cIjtcbiAgICBwcml2YXRlIHFHZXRBbGxRdWV1ZVN0YXR1cyA9IFwiU0VMRUNUICogRlJPTSBxdWV1ZSBXSEVSRSBzdGF0dXM9P1wiO1xuICAgIHByaXZhdGUgcUdldEFsbEZvcm1zID0gXCJTRUxFQ1QgKiBGUk9NIGZvcm1zXCI7XG4gICAgcHJpdmF0ZSBxR2V0QWxsU2V0dGluZ3MgPSBcIlNFTEVDVCAqIEZST00gc2V0dGluZ3NcIjtcbiAgICBwcml2YXRlIHFHZXRBbGxRdWV1ZSA9IFwiU0VMRUNUICogRlJPTSBxdWV1ZVwiO1xuXG4gICAgLy9TZXR0ZXJzXG4gICAgcHJpdmF0ZSBxU2V0U2V0dGluZyA9IFwiSU5TRVJUIE9SIFJFUExBQ0UgSU5UTyBzZXR0aW5ncyAoaWQsIGBrZXlgLCBgdmFsdWVgKSBWQUxVRVMgKChTRUxFQ1QgaWQgRlJPTSBzZXR0aW5ncyBXSEVSRSBga2V5YD0/KSw/LD8pXCI7XG4gICAgcHJpdmF0ZSBxU2V0Rm9ybSA9IFwiSU5TRVJUIE9SIFJFUExBQ0UgSU5UTyBmb3JtcyAoaWQsIGZvcm1faWQsIHRpdGxlLCBqc29uKSBWQUxVRVMgKChTRUxFQ1QgaWQgRlJPTSBmb3JtcyBXSEVSRSBgZm9ybV9pZGA9PyksPyw/LD8pXCI7XG4gICAgcHJpdmF0ZSBxQWRkVG9RdWV1ZSA9IFwiSU5TRVJUIElOVE8gcXVldSAoZm9ybV9pZCwgcGF5bG9hZCkgVkFMVUVTICg/LD8pXCI7XG4gICAgcHJpdmF0ZSBxVXBkYXRlUXVldSA9IFwiVVBEQVRFIHF1ZXVlIFNFVCBzdGF0dXM9PyBXSEVSRSBmb3JtX2lkPT9cIjtcbiAgICBwcml2YXRlIHFDbGVhclF1ZXVlID0gXCJERUxFVEUgKiBGUk9NIHF1ZXVcIjtcbiAgICBwcml2YXRlIHFDbGVhckZvcm1zID0gXCJERUxFVEUgKiBGUk9NIGZvcm1zXCI7XG4gICAgcHJpdmF0ZSBxQ2xlYXJTZXR0aW5ncyA9IFwiREVMRVRFICogRlJPTSBzZXR0aW5nc1wiO1xuICAgIHByaXZhdGUgcURlbGV0ZVNldHRpbmcgPSBcIkRFTEVURSBGUk9NIHNldHRpbmdzIFdIRVJFIGBrZXlgPT9cIjtcblxuXG5cbiAgICBwdWJsaWMgY29uc3RydWN0b3IoKXtcbiAgICAgICAgLy9EQiBBYW5tYWtlbiArIHRhYmVsbGVuXG4gICAgICAgIGlmKCF0aGlzLmlzSW5zdGFudGlhdGVkKXtcbiAgICAgICAgICAgIC8vc3FsLmRlbGV0ZURhdGFiYXNlKHRoaXMucURibmFtZSk7XG4gICAgICAgICAgICB0aGlzLmRiID0gKG5ldyBzcWwodGhpcy5xRGJuYW1lKSk7XG4gICAgICAgICAgICB0aGlzLmRiLnRoZW4oZGI9PnsgXG4gICAgICAgICAgICAgICAgZGIuZXhlY1NRTCh0aGlzLnFDcmVhdGVTZXR0aW5nc1RhYmxlKS50aGVuKGlkPT57XG4gICAgICAgICAgICAgICAgfSwgZXJyb3IgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gY3JlYXRlIHNldHRpbmdzIHRhYmxlIScpO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgZGIuZXhlY1NRTCh0aGlzLnFDcmVhdGVGb3Jtc1RhYmxlKS50aGVuKGlkPT57XG4gICAgICAgICAgICAgICAgfSwgZXJyb3IgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gY3JlYXRlIGZvcm1zIHRhYmxlIScpO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgZGIuZXhlY1NRTCh0aGlzLnFDcmVhdGVRdWV1ZXNUYWJsZSkudGhlbihpZD0+e1xuICAgICAgICAgICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGNyZWF0ZSBxdWV1cyB0YWJsZSEnKTtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIC8vdGhpcy5kYiA9IGRiO1xuICAgICAgICAgICAgICAgIHRoaXMuaXNJbnN0YW50aWF0ZWQgPSB0cnVlO1xuXG4gICAgICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIG9wZW4gREIhJyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGdldERiSGFuZGxlcigpe1xuICAgICAgICByZXR1cm4gdGhpcy5kYjtcbiAgICB9XG5cbiAgICBzZXRBdXRoKHRva2VuX2lkKXtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2V0U2V0dGluZygnYXV0aCcsdG9rZW5faWQpO1xuICAgIH1cblxuICAgIGdldEF1dGgoKXtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2V0dGluZygnYXV0aCcpO1xuICAgIH1cblxuICAgIGNsZWFyQXV0aCgpe1xuICAgICAgICB0aGlzLmRiLnRoZW4oZGI9PntcbiAgICAgICAgICAgIGRiLmV4ZWNTUUwodGhpcy5xRGVsZXRlU2V0dGluZyxbJ2F1dGgnXSkudGhlbigoKT0+e1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSwgZXJyb3IgPT4gdGhpcy5lcnJvckhhbmRsZXIoZXJyb3IpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc2V0Rm9ybShmb3JtKXtcbiAgICAgICAgdGhpcy5kYi50aGVuKGRiPT57XG4gICAgICAgICAgICBkYi5leGVjU1FMKHRoaXMucVNldEZvcm0sW2Zvcm0uSWQsIGZvcm0uSWQsZm9ybS5UaXRsZSxmb3JtXSkudGhlbih2YWx1ZT0+e1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSwgZXJyb3IgPT4gdGhpcy5lcnJvckhhbmRsZXIoZXJyb3IpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0Rm9ybShmb3JtX2lkKXtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIudGhlbihkYj0+e1xuICAgICAgICAgICAgcmV0dXJuIGRiLmdldCh0aGlzLnFHZXRGb3JtLFtmb3JtX2lkXSwgZnVuY3Rpb24oZXJyLHJvdyl7XG4gICAgICAgICAgICAgICAgLy9yb3dbMl07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0QWxsRm9ybXMoKXtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIudGhlbihkYj0+e1xuICAgICAgICAgICAgcmV0dXJuIGRiLmV4ZWNTUUwodGhpcy5xR2V0QWxsRm9ybXMsZnVuY3Rpb24oZXJyLHJvd3Mpe30pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBjbGVhckZvcm1zKCl7XG4gICAgICAgIHRoaXMuZGIudGhlbihkYj0+e1xuICAgICAgICAgICAgZGIuZXhlY1NRTCh0aGlzLnFDbGVhckZvcm1zKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0U2V0dGluZ3MoKXtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIudGhlbihkYj0+e1xuICAgICAgICAgICAgcmV0dXJuIGRiLmFsbCh0aGlzLnFHZXRBbGxTZXR0aW5ncykudGhlbihyb3dzPT57XG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmR1bXAocm93cyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJvd3M7XG4gICAgICAgICAgICB9LCBlcnJvciA9PiB0aGlzLmVycm9ySGFuZGxlcihlcnJvcikgKTtcbiAgICAgICAgfSk7XG4gICAgfSBcblxuXG4gICAgZ2V0U2V0dGluZyhrZXkpe1xuICAgICAgICByZXR1cm4gdGhpcy5kYi50aGVuKGRiPT57XG4gICAgICAgICAgICByZXR1cm4gZGIuZ2V0KHRoaXMucUdldFNldHRpbmcsW2tleV0sIGZ1bmN0aW9uKGVycixyb3cpe1xuICAgICAgICAgICAgICAgIGlmKGVycil7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXJyb3JIYW5kbGVyKGVycik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHNldFNldHRpbmcoa2V5LCB2YWx1ZSl7XG4gICAgICAgIHJldHVybiB0aGlzLmRiLnRoZW4oZGI9PntcbiAgICAgICAgICAgIHJldHVybiBkYi5leGVjU1FMKHRoaXMucVNldFNldHRpbmcsW2tleSwga2V5LHZhbHVlXSkudGhlbih2YWx1ZT0+e1xuICAgICAgICAgICAgfSwgZXJyb3IgPT4gdGhpcy5lcnJvckhhbmRsZXIoZXJyb3IpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc2V0U2V0dGluZ3Moc2V0dGluZ3Mpe1xuICAgICAgICByZXR1cm4gdGhpcy5kYi50aGVuKGRiPT57XG4gICAgICAgICAgICBmb3IobGV0IGtleSBpbiBzZXR0aW5ncyl7XG4gICAgICAgICAgICAgICAgZGIuZXhlY1NRTCh0aGlzLnFTZXRTZXR0aW5nLFtrZXksIGtleSwgc2V0dGluZ3Nba2V5XV0pXG4gICAgICAgICAgICAgICAgLnRoZW4ocmVzPT57fSwgZXJyb3IgPT4gdGhpcy5lcnJvckhhbmRsZXIoZXJyb3IpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgY2xlYXJTZXR0aW5ncygpe1xuICAgICAgICB0aGlzLmRiLnRoZW4oZGI9PntcbiAgICAgICAgICAgIGRiLmV4ZWNTUUwodGhpcy5xQ2xlYXJTZXR0aW5ncyk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFkZFRvUXVldWUoZm9ybV9pZCwgcGF5bG9hZCl7XG4gICAgICAgIHJldHVybiB0aGlzLmRiLnRoZW4oZGI9PntcbiAgICAgICAgICAgIHJldHVybiBkYi5leGVjU1FMKHRoaXMucUFkZFRvUXVldWUsW2Zvcm1faWQsIHBheWxvYWRdKS50aGVuKGlkPT57XG4gICAgICAgICAgICAgICAgLy9yZXR1cm5zIElEXG4gICAgICAgICAgICB9LCBlcnJvciA9PiB0aGlzLmVycm9ySGFuZGxlcihlcnJvcikpO1xuICAgICAgICB9KTtcbiAgICAgICBcbiAgICB9XG5cbiAgICBnZXRPbmVRdWV1ZShxdWV1X2lkKXtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIudGhlbihkYj0+e1xuICAgICAgICAgICAgcmV0dXJuIGRiLmdldChcbiAgICAgICAgICAgICAgICB0aGlzLnFHZXRPbmVRdWV1ZSxbcXVldV9pZF0sXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24oZXJyLHJvdyl7fVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0UXVldWVXaXRoU3RhdHVzKHN0YXR1cyl7XG4gICAgICAgIHJldHVybiB0aGlzLmRiLnRoZW4oZGI9PntcbiAgICAgICAgICAgIHJldHVybiBkYi5leGVjU1FMKFxuICAgICAgICAgICAgICAgIHRoaXMucUdldEFsbFF1ZXVlU3RhdHVzLFtzdGF0dXNdLCBcbiAgICAgICAgICAgICAgICBmdW5jdGlvbihlcnIscm93cyl7fVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7IFxuICAgIH1cblxuICAgIGdldFF1ZXVlKCl7XG4gICAgICAgIHJldHVybiB0aGlzLmRiLnRoZW4oZGI9PntcbiAgICAgICAgICAgIHJldHVybiBkYi5leGVjU1FMKFxuICAgICAgICAgICAgICAgIHRoaXMucUdldEFsbFF1ZXVlLCBcbiAgICAgICAgICAgICAgICBmdW5jdGlvbihlcnIscm93cyl7fVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgY2xlYXJRdWV1KCl7XG4gICAgICAgIHRoaXMuZGIudGhlbihkYj0+e1xuICAgICAgICAgICAgZGIuZXhlY1NRTCh0aGlzLnFDbGVhclF1ZXVlKTtcbiAgICAgICAgfSk7XG4gICAgfSBcblxuICAgIGNsZWFyQWxsKCl7XG4gICAgICAgIHRoaXMuY2xlYXJGb3JtcygpO1xuICAgICAgICB0aGlzLmNsZWFyUXVldSgpO1xuICAgICAgICB0aGlzLmNsZWFyU2V0dGluZ3MoKTtcbiAgICB9XG5cbiAgICBlcnJvckhhbmRsZXIoZXJyb3Ipe1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3I6IFwiK2Vycm9yKTtcbiAgICB9XG59Il19